window.CMB2=function(e,t,i,a){"use strict";var r=e.cmb2_l10,n=e.setTimeout,o={idNumber:!1,repeatEls:'input:not([type="button"],[id^=filelist]),select,textarea,.cmb2-media-status',noEmpty:'input:not([type="button"]):not([type="radio"]):not([type="checkbox"]),textarea',repeatUpdate:'input:not([type="button"]),select,textarea,label',styleBreakPoint:450,mediaHandlers:{},neweditor_id:[],defaults:{time_picker:r.defaults.time_picker,date_picker:r.defaults.date_picker,color_picker:r.defaults.color_picker||{}},media:{frames:{}}},d=function(e){return i(t.getElementById(e))};return o.metabox=function(){return o.$metabox?o.$metabox:(o.$metabox=i(".cmb2-wrap > .cmb2-metabox"),o.$metabox)},o.init=function(){o.log("CMB2 localized data",r);var a=o.metabox(),l=a.find(".cmb-repeatable-group");o.initPickers(a.find('input[type="text"].cmb2-timepicker'),a.find('input[type="text"].cmb2-datepicker'),a.find('input[type="text"].cmb2-colorpicker')),i('<p><span class="button cmb-multicheck-toggle">'+r.strings.check_toggle+"</span></p>").insertBefore(".cmb2-checkbox-list:not(.no-select-all)"),o.makeListSortable(),a.on("change",".cmb2_upload_file",function(){o.media.field=i(this).attr("id"),d(o.media.field+"_id").val("")}).on("click",".cmb-multicheck-toggle",o.toggleCheckBoxes).on("click",".cmb2-upload-button",o.handleMedia).on("click",".cmb-attach-list li, .cmb2-media-status .img-status img, .cmb2-media-status .file-status > span",o.handleFileClick).on("click",".cmb2-remove-file-button",o.handleRemoveMedia).on("click",".cmb-add-group-row",o.addGroupRow).on("click",".cmb-add-row-button",o.addAjaxRow).on("click",".cmb-remove-group-row",o.removeGroupRow).on("click",".cmb-remove-row-button",o.removeAjaxRow).on("keyup paste focusout",".cmb2-oembed",o.maybeOembed).on("cmb2_remove_row",".cmb-repeatable-group",o.resetTitlesAndIterator).on("click",".cmbhandle, .cmbhandle + .cmbhandle-title",o.toggleHandle),l.length&&l.filter(".sortable").each(function(){i(this).find(".button.cmb-remove-group-row").before('<a class="button cmb-shift-rows move-up alignleft" href="#"><span class="'+r.up_arrow_class+'"></span></a> <a class="button cmb-shift-rows move-down alignleft" href="#"><span class="'+r.down_arrow_class+'"></span></a>')}).on("click",".cmb-shift-rows",o.shiftRows).on("cmb2_add_row",o.emptyValue),n(o.resizeoEmbeds,500),i(e).on("resize",o.resizeoEmbeds),i(t).trigger("cmb_init",o)},o.resetTitlesAndIterator=function(){i(".cmb-repeatable-group").each(function(){var e=i(this);e.find(".cmb-repeatable-grouping").each(function(t){var a=i(this);a.data("iterator",t),a.find(".cmb-group-title h4").text(e.find(".cmb-add-group-row").data("grouptitle").replace("{#}",t+1))})})},o.toggleHandle=function(e){e.preventDefault(),i(t).trigger("postbox-toggled",i(this).parent(".postbox").toggleClass("closed"))},o.toggleCheckBoxes=function(e){e.preventDefault();var t=i(this),a=t.closest(".cmb-td").find("input[type=checkbox]:not([disabled])");t.data("checked")?(a.prop("checked",!1),t.data("checked",!1)):(a.prop("checked",!0),t.data("checked",!0))},o.handleMedia=function(e){e.preventDefault();var t=i(this);o.attach_id=t.hasClass("cmb2-upload-list")?!1:t.closest(".cmb-td").find(".cmb2-upload-file-id").val(),o.attach_id="0"!==o.attach_id?o.attach_id:!1,o._handleMedia(t.prev("input.cmb2-upload-file").attr("id"),t.hasClass("cmb2-upload-list"))},o.handleFileClick=function(e){e.preventDefault();var t=i(this),a=t.closest(".cmb-td"),r=a.find(".cmb2-upload-button").hasClass("cmb2-upload-list");o.attach_id=r?t.find('input[type="hidden"]').data("id"):a.find(".cmb2-upload-file-id").val(),o.attach_id&&o._handleMedia(a.find("input.cmb2-upload-file").attr("id"),r,o.attach_id)},o._handleMedia=function(e,t){if(wp){var a=o.media;a.field=e,a.$field=d(a.field),a.fieldData=a.$field.data(),a.previewSize=a.fieldData.previewsize,a.fieldName=a.$field.attr("name");var n,l;if(a.field in a.frames)return void a.frames[a.field].open();a.frames[a.field]=wp.media({frame:null==wp.media.model.settings.post.id||0==wp.media.model.settings.post.id?"":"post",title:o.metabox().find("label[for="+a.field+"]").text(),library:a.fieldData.queryargs||{},button:{text:r.strings[t?"upload_files":"upload_file"]},multiple:t?"add":!1}),o.mediaHandlers.list=function(e,t){l=e.toJSON(),a.$field.val(l.url),d(a.field+"_id").val(l.id);var o=[];return i(l).each(function(){if(this.type&&"image"===this.type){var e=a.previewSize[0]?a.previewSize[0]:50,t=a.previewSize[1]?a.previewSize[1]:50;n='<li class="img-status"><img width="'+e+'" height="'+t+'" src="'+this.url+'" class="attachment-'+e+"px"+t+'px" alt="'+this.filename+'"><p><a href="#" class="cmb2-remove-file-button" rel="'+a.field+"["+this.id+']">'+r.strings.remove_image+'</a></p><input type="hidden" id="filelist-'+this.id+'" data-id="'+this.id+'" name="'+a.fieldName+"["+this.id+']" value="'+this.url+'"></li>'}else n='<li class="file-status"><span>'+r.strings.file+" <strong>"+this.filename+'</strong></span>&nbsp;&nbsp; (<a href="'+this.url+'" target="_blank" rel="external">'+r.strings.download+'</a> / <a href="#" class="cmb2-remove-file-button" rel="'+a.field+"["+this.id+']">'+r.strings.remove_file+'</a>)<input type="hidden" id="filelist-'+this.id+'" data-id="'+this.id+'" name="'+a.fieldName+"["+this.id+']" value="'+this.url+'"></li>';o.push(n)}),t?o:void i(o).each(function(){a.$field.siblings(".cmb2-media-status").slideDown().append(this)})},o.mediaHandlers.single=function(e){if(l=e.first().toJSON(),a.$field.val(l.url),d(a.field+"_id").val(l.id),l.type&&"image"===l.type){var t=a.previewSize[0]?a.previewSize[0]:350;n='<div class="img-status"><img width="'+t+'px" style="max-width: '+t+'px; width: 100%; height: auto;" src="'+l.url+'" alt="'+l.filename+'" title="'+l.filename+'" /><p><a href="#" class="cmb2-remove-file-button" rel="'+a.field+'">'+r.strings.remove_image+"</a></p></div>"}else n='<div class="file-status"><span>'+r.strings.file+" <strong>"+l.filename+'</strong></span>&nbsp;&nbsp; (<a href="'+l.url+'" target="_blank" rel="external">'+r.strings.download+'</a> / <a href="#" class="cmb2-remove-file-button" rel="'+a.field+'">'+r.strings.remove_file+"</a>)</div>";a.$field.siblings(".cmb2-media-status").slideDown().html(n)},o.mediaHandlers.selectFile=function(){var e=a.frames[a.field].state().get("selection"),r=t?"list":"single";return o.attach_id&&t?void i('[data-id="'+o.attach_id+'"]').parents("li").replaceWith(o.mediaHandlers.list(e,!0)):void o.mediaHandlers[r](e)},o.mediaHandlers.openModal=function(){var e=a.frames[a.field].state().get("selection");if(!o.attach_id)return e.reset();var t=wp.media.attachment(o.attach_id);t.fetch(),e.set(t?[t]:[])},a.frames[a.field].on("select",o.mediaHandlers.selectFile).on("open",o.mediaHandlers.openModal),a.frames[a.field].open()}},o.handleRemoveMedia=function(e){e.preventDefault();var t=i(this);return t.is(".cmb-attach-list .cmb2-remove-file-button")?(t.parents("li").remove(),!1):(o.media.field=t.attr("rel"),o.metabox().find("input#"+o.media.field).val(""),o.metabox().find("input#"+o.media.field+"_id").val(""),t.parents(".cmb2-media-status").html(""),!1)},o.cleanRow=function(e,t,r){var n=e.find(o.repeatUpdate);if(r){var d=e.find("[id]").not(o.repeatUpdate);e.find(".cmb-repeat-table .cmb-repeat-row:not(:first-child)").remove(),d.length&&d.each(function(){var a=i(this),r=a.attr("id"),n=r.replace("_"+t,"_"+o.idNumber),d=e.find('[data-selector="'+r+'"]');a.attr("id",n),d.length&&d.attr("data-selector",n).data("selector",n)})}return o.neweditor_id=[],n.filter(":checked").prop("checked",!1),n.filter(":selected").prop("selected",!1),e.find("h3.cmb-group-title").length&&e.find("h3.cmb-group-title").text(e.data("title").replace("{#}",o.idNumber+1)),n.each(function(){var e,r,n=i(this),d=n.hasClass("wp-editor-area"),l=n.attr("for"),c=n.val(),s=n.prop("type"),p="radio"===s||"checkbox"===s?c:!1,m={};if(l)m={"for":l.replace("_"+t,"_"+o.idNumber)};else{var u=n.attr("name"),f=u?u.replace("["+t+"]","["+o.idNumber+"]"):"";r=n.attr("id"),e=r?r.replace("_"+t,"_"+o.idNumber):"",m={id:e,name:f,"data-iterator":o.idNumber}}if((a!==typeof c&&c||p)&&(m.value=p?p:""),"TEXTAREA"===n.prop("tagName")&&n.html(""),p&&n.removeAttr("checked"),n.removeClass("hasDatepicker").attr(m).val(p?p:""),d){e=e?r.replace("zx"+t,"zx"+o.idNumber):"",n.html("");var b=n.parents(".cmb-type-wysiwyg");b.find(".mce-tinymce:not(:first-child)").remove();var h=b.html().replace(new RegExp(r,"g"),e);b.html(h),o.neweditor_id.push({id:e,old:r})}}),o},o.newRowHousekeeping=function(e){var t=e.find(".wp-picker-container"),a=e.find(".cmb2-media-status");return t.length&&t.each(function(){var e=i(this).parent();e.html(e.find('input[type="text"].cmb2-colorpicker').attr("style",""))}),a.length&&a.empty(),o},o.afterRowInsert=function(e){var t;if(o.neweditor_id.length){var i;for(i=o.neweditor_id.length-1;i>=0;i--){var a=o.neweditor_id[i].id,r=o.neweditor_id[i].old;if("undefined"==typeof tinyMCEPreInit.mceInit[a]){var n=jQuery.extend({},tinyMCEPreInit.mceInit[r]);for(t in n)"string"==typeof n[t]&&(n[t]=n[t].replace(new RegExp(r,"g"),a));tinyMCEPreInit.mceInit[a]=n}if("undefined"==typeof tinyMCEPreInit.qtInit[a]){var d=jQuery.extend({},tinyMCEPreInit.qtInit[r]);for(t in d)"string"==typeof d[t]&&(d[t]=d[t].replace(new RegExp(r,"g"),a));tinyMCEPreInit.qtInit[a]=d}tinyMCE.init({id:tinyMCEPreInit.mceInit[a]})}}o.initPickers(e.find('input[type="text"].cmb2-timepicker'),e.find('input[type="text"].cmb2-datepicker'),e.find('input[type="text"].cmb2-colorpicker'))},o.updateNameAttr=function(){var e=i(this),t=e.attr("name");if("undefined"!=typeof t){var a=parseInt(e.parents(".cmb-repeatable-grouping").data("iterator")),r=a-1,n=t.replace("["+a+"]","["+r+"]");e.attr("name",n)}},o.emptyValue=function(e,t){i(o.noEmpty,t).val("")},o.addGroupRow=function(e){e.preventDefault();var t=i(this);t.trigger("cmb2_add_group_row_start",t);var a=d(t.data("selector")),r=a.find(".cmb-repeatable-grouping").last(),n=parseInt(r.data("iterator"));o.idNumber=n+1;var l=r.clone();o.newRowHousekeeping(l.data("title",t.data("grouptitle"))).cleanRow(l,n,!0),l.find(".cmb-add-row-button").prop("disabled",!1);var c=i('<div class="postbox cmb-row cmb-repeatable-grouping" data-iterator="'+o.idNumber+'">'+l.html()+"</div>");r.after(c),o.afterRowInsert(c),a.find(".cmb-repeatable-grouping").length<=1?a.find(".cmb-remove-group-row").prop("disabled",!0):a.find(".cmb-remove-group-row").prop("disabled",!1),a.trigger("cmb2_add_row",c)},o.addAjaxRow=function(e){e.preventDefault();var t=i(this),a=d(t.data("selector")),r=a.find(".empty-row"),n=parseInt(r.find("[data-iterator]").data("iterator"));o.idNumber=n+1;var l=r.clone();o.newRowHousekeeping(l).cleanRow(l,n),r.removeClass("empty-row hidden").addClass("cmb-repeat-row"),r.after(l),o.afterRowInsert(l),a.trigger("cmb2_add_row",l),a.find(".cmb-remove-row-button").removeClass("button-disabled")},o.removeGroupRow=function(e){e.preventDefault();var t=i(this),a=d(t.data("selector")),r=t.parents(".cmb-repeatable-grouping"),n=a.find(".cmb-repeatable-grouping").length;n>1&&(a.trigger("cmb2_remove_group_row_start",t),r.nextAll(".cmb-repeatable-grouping").find(o.repeatEls).each(o.updateNameAttr),r.remove(),2>=n?a.find(".cmb-remove-group-row").prop("disabled",!0):a.find(".cmb-remove-group-row").prop("disabled",!1),a.trigger("cmb2_remove_row"))},o.removeAjaxRow=function(e){e.preventDefault();var t=i(this);if(!t.hasClass("button-disabled")){var a=t.parents(".cmb-row"),r=t.parents(".cmb-repeat-table"),n=r.find(".cmb-row").length;n>2?(a.hasClass("empty-row")&&a.prev().addClass("empty-row").removeClass("cmb-repeat-row"),t.parents(".cmb-repeat-table .cmb-row").remove(),3===n&&r.find(".cmb-remove-row-button").addClass("button-disabled"),r.trigger("cmb2_remove_row")):t.addClass("button-disabled")}},o.shiftRows=function(e){e.preventDefault();var t=i(this);t.trigger("cmb2_shift_rows_enter",t);var a=t.parents(".cmb-repeatable-grouping"),r=t.hasClass("move-up")?a.prev(".cmb-repeatable-grouping"):a.next(".cmb-repeatable-grouping");if(r.length){t.trigger("cmb2_shift_rows_start",t);var n=[];a.find(o.repeatEls).each(function(){var e,t=i(this),a=t.attr("type");e=t.hasClass("cmb2-media-status")?t.html():"checkbox"===a||"radio"===a?t.is(":checked"):"select"===t.prop("tagName")?t.is(":selected"):t.val(),n.push({val:e,$:t})}),r.find(o.repeatEls).each(function(e){var t,a=i(this),r=a.attr("type");if(a.hasClass("cmb2-media-status")){var o=a.closest(".cmb-repeatable-grouping").attr("data-iterator"),d=n[e].$.closest(".cmb-repeatable-grouping").attr("data-iterator");t=a.html(),a.html(n[e].val),n[e].$.html(t),n[e].$.find("input").each(function(){var e=i(this).attr("name");e=e.replace("["+o+"]","["+d+"]"),i(this).attr("name",e)}),a.find("input").each(function(){var e=i(this).attr("name");e=e.replace("["+d+"]","["+o+"]"),i(this).attr("name",e)})}else"checkbox"===r?(n[e].$.prop("checked",a.is(":checked")),a.prop("checked",n[e].val)):"radio"===r?(a.is(":checked")&&n[e].$.attr("data-checked","true"),n[e].$.is(":checked")&&a.attr("data-checked","true")):"select"===a.prop("tagName")?(n[e].$.prop("selected",a.is(":selected")),a.prop("selected",n[e].val)):(n[e].$.val(a.val()),a.val(n[e].val))}),a.find("input[data-checked=true]").prop("checked",!0).removeAttr("data-checked"),r.find("input[data-checked=true]").prop("checked",!0).removeAttr("data-checked"),a.find('input[type="text"].cmb2-colorpicker').trigger("change"),r.find('input[type="text"].cmb2-colorpicker').trigger("change"),t.trigger("cmb2_shift_rows_complete",t)}},o.initPickers=function(e,t,i){o.initDateTimePickers(e,"timepicker","time_picker"),o.initDateTimePickers(t,"datepicker","date_picker"),o.initColorPickers(i)},o.initDateTimePickers=function(e,t,a){e.length&&e[t]("destroy").each(function(){var e=i(this),r=e.data(t)||{},n=i.extend({},o.defaults[a],r);e[t](o.datePickerSetupOpts(r,n))})},o.datePickerSetupOpts=function(e,t){return t.beforeShow=function(t,i){d("ui-datepicker-div").addClass("cmb2-element"),"function"==typeof e.beforeShow&&e.beforeShow(t,i)},t.onClose=function(t,i){d("ui-datepicker-div").removeClass("cmb2-element").hide(),"function"==typeof e.onClose&&e.onClose(t,i)},t},o.initColorPickers=function(e){e.length&&("object"==typeof jQuery.wp&&"function"==typeof jQuery.wp.wpColorPicker?e.each(function(){var e=i(this),t=e.data("colorpicker")||{};e.wpColorPicker(i.extend({},o.defaults.color_picker,t))}):e.each(function(e){i(this).after('<div id="picker-'+e+'" style="z-index: 1000; background: #EEE; border: 1px solid #CCC; position: absolute; display: block;"></div>'),d("picker-"+e).hide().farbtastic(i(this))}).focus(function(){i(this).next().show()}).blur(function(){i(this).next().hide()}))},o.makeListSortable=function(){var e=o.metabox().find(".cmb2-media-status.cmb-attach-list");e.length&&e.sortable({cursor:"move"}).disableSelection()},o.maybeOembed=function(e){var t=i(this),a={focusout:function(){n(function(){o.spinner(".postbox .cmb2-metabox",!0)},2e3)},keyup:function(){var i=function(t,i){return e.which<=i&&e.which>=t};(i(48,90)||i(96,111)||i(8,9)||187===e.which||190===e.which)&&o.doAjax(t,e)},paste:function(){n(function(){o.doAjax(t)},100)}};a[e.type]()},o.resizeoEmbeds=function(){o.metabox().each(function(){var e=i(this),t=e.parents(".inside"),a=e.parents(".inner-sidebar").length||e.parents("#side-sortables").length,r=a,n=!1;if(!t.length)return!0;var d=t.width();o.styleBreakPoint>d&&(r=!0,n=o.styleBreakPoint-62>d),d=r?d:Math.round(.82*t.width()*.97);var l=d-30;if(!r||a||n||(l-=75),l>639)return!0;var c=e.find(".cmb-type-oembed .embed-status"),s=c.children().not(".cmb2-remove-wrapper");return s.length?void s.each(function(){var e=i(this),t=e.width(),a=e.height(),n=l;e.parents(".cmb-repeat-row").length&&!r&&(n=l-91,n=785>d?n-15:n);var o=Math.round(n*a/t);e.width(n).height(o)}):!0})},o.log=function(){r.script_debug&&console&&"function"==typeof console.log&&console.log.apply(console,arguments)},o.spinner=function(e,t){t?i(".cmb-spinner",e).hide():i(".cmb-spinner",e).show()},o.doAjax=function(e){var t=e.val();if(!(t.length<6)){var a=e.attr("id"),d=e.closest(".cmb-td"),l=d.find(".embed-status"),c=d.find(".embed_wrap"),s=l.find(":first-child"),p=l.length&&s.length?s.width():e.width();o.log("oembed_url",t,a),o.spinner(d),c.html(""),n(function(){i(".cmb2-oembed:focus").val()===t&&i.ajax({type:"post",dataType:"json",url:r.ajaxurl,data:{action:"cmb2_oembed_handler",oembed_url:t,oembed_width:p>300?p:300,field_id:a,object_id:e.data("objectid"),object_type:e.data("objecttype"),cmb2_ajax_nonce:r.ajax_nonce},success:function(e){o.log(e),o.spinner(d,!0),c.html(e.data)}})},500)}},i(o.init),o}(window,document,jQuery);
